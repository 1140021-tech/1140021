<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觀音廟線上拜拜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            touch-action: manipulation;
        }
        .temple-bg {
            background-color: #581c1c;
            background-image:
                radial-gradient(circle at 50% 0, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 25%),
                radial-gradient(circle at 100% 50%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 25%),
                radial-gradient(circle at 0 50%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 25%);
        }
        .altar {
            background: #6f4e37;
            border: 4px solid #a07b5f;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.5);
        }
        .btn-action {
            background-color: #d4af37;
            border: 2px solid #b8860b;
            color: #4a2c2a;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-action:hover {
            background-color: #e6c35c;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }
        .btn-action:disabled {
            background-color: #a9a9a9;
            border-color: #808080;
            color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .offering {
            transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .offering.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #fortune-slip {
            background-color: #fffbeb;
            border: 2px solid #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        .flicker {
            animation: flickerAnimation 2s infinite;
        }
        @keyframes flickerAnimation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="temple-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-4xl mx-auto bg-black bg-opacity-20 rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8">
        
        <!-- 標題 -->
        <header class="text-center mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-yellow-200" style="text-shadow: 2px 2px 4px #000;">觀音廟 線上祈福</h1>
            <p class="text-yellow-300 text-sm sm:text-base">請以虔誠的心，完成參拜流程</p>
        </header>

        <!-- 遊戲主場景 -->
        <div class="flex flex-col items-center">
            <!-- 觀音像 -->
            <div class="relative mb-4">
                <img src="https://i.pinimg.com/564x/a0/a7/9b/a0a79b7600f135a5196238b9a19f2683.jpg" alt="Q版觀音像" class="rounded-lg shadow-lg" style="border: 4px solid #d4af37; max-height: 450px; width: auto; object-fit: cover;">
                <!-- 香爐與香 -->
                <div id="incense" class="offering absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-24 h-20 flex flex-col items-center">
                     <div class="w-24 h-12 bg-bronze-700 flex justify-center items-end" style="background-color: #8c7853; border-radius: 5px 5px 15px 15px; border: 2px solid #5a4d3a;">
                        <div class="flex space-x-1">
                            <div class="w-0.5 h-8 bg-red-400 flicker"></div>
                            <div class="w-0.5 h-8 bg-red-400 flicker" style="animation-delay: 0.5s;"></div>
                            <div class="w-0.5 h-8 bg-red-400 flicker" style="animation-delay: 1s;"></div>
                        </div>
                    </div>
                    <div class="w-20 h-2 bg-yellow-900"></div>
                </div>
            </div>

            <!-- 神桌 -->
            <div class="altar w-full max-w-xl h-24 rounded-lg flex justify-center items-end p-2 gap-4">
                <div id="flowers" class="offering text-center">
                    <div class="text-5xl">💐</div>
                    <div class="text-xs text-yellow-200">鮮花</div>
                </div>
                <div id="fruits" class="offering text-center">
                    <div class="text-5xl">🍎🍊</div>
                    <div class="text-xs text-yellow-200">水果</div>
                </div>
            </div>
        </div>

        <!-- 互動區 -->
        <div class="mt-6 p-4 bg-black bg-opacity-30 rounded-lg">
            <!-- 訊息顯示 -->
            <div id="message-board" class="min-h-[60px] text-center text-yellow-200 text-lg mb-4 flex items-center justify-center p-2 rounded-md bg-black bg-opacity-20">
                請點擊「上香」開始您的參拜。
            </div>

            <!-- 祈福輸入框 -->
            <div id="prayer-section" class="hidden flex-col items-center mb-4">
                <textarea id="prayer-text" class="w-full max-w-md p-2 rounded-md bg-yellow-100 text-gray-800 focus:outline-none focus:ring-2 focus:ring-d4af37" rows="3" placeholder="請在此輸入您的祈願..."></textarea>
                <button id="submit-prayer-btn" class="btn-action font-bold py-2 px-6 rounded-lg mt-2">默念祈禱</button>
            </div>

            <!-- 擲筊和求籤結果 -->
            <div id="result-section" class="text-center">
                <div id="jiaobei-result" class="text-2xl font-bold text-white mb-2"></div>
                <div id="fortune-slip" class="hidden p-4 rounded-lg mx-auto max-w-md mt-4">
                    <h3 id="fortune-title" class="text-2xl font-bold text-red-700 text-center mb-2"></h3>
                    <p id="fortune-text" class="text-gray-700 text-center"></p>
                    <!-- Gemini API Feature: AI解籤 -->
                    <div id="gemini-section" class="mt-4 text-center hidden">
                        <button id="gemini-btn" class="btn-action font-bold py-2 px-6 rounded-lg">✨ 請觀音開示</button>
                        <div id="gemini-loading" class="hidden mt-4 text-yellow-200">觀音菩薩正在傾聽您的心聲，請稍候...</div>
                        <div id="gemini-result" class="mt-4 p-3 text-left bg-white rounded-md text-gray-800" style="white-space: pre-wrap; display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div id="controls" class="flex flex-wrap justify-center gap-2 sm:gap-4">
                <button id="incense-btn" class="btn-action font-bold py-2 px-4 rounded-lg">1. 上香</button>
                <button id="offering-btn" class="btn-action font-bold py-2 px-4 rounded-lg" disabled>2. 獻上供品</button>
                <button id="pray-btn" class="btn-action font-bold py-2 px-4 rounded-lg" disabled>3. 誠心祈福</button>
                <button id="cast-blocks-btn" class="btn-action font-bold py-2 px-4 rounded-lg" disabled>4. 擲筊問事</button>
                <button id="draw-fortune-btn" class="btn-action font-bold py-2 px-4 rounded-lg" disabled>5. 求取靈籤</button>
                <button id="reset-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition">重新參拜</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const messageBoard = document.getElementById('message-board');
        const incense = document.getElementById('incense');
        const fruits = document.getElementById('fruits');
        const flowers = document.getElementById('flowers');
        const prayerSection = document.getElementById('prayer-section');
        const prayerText = document.getElementById('prayer-text');
        const jiaobeiResult = document.getElementById('jiaobei-result');
        
        // Fortune and Gemini Elements
        const fortuneSlip = document.getElementById('fortune-slip');
        const fortuneTitle = document.getElementById('fortune-title');
        const fortuneText = document.getElementById('fortune-text');
        const geminiSection = document.getElementById('gemini-section');
        const geminiBtn = document.getElementById('gemini-btn');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResult = document.getElementById('gemini-result');
        
        // Buttons
        const incenseBtn = document.getElementById('incense-btn');
        const offeringBtn = document.getElementById('offering-btn');
        const prayBtn = document.getElementById('pray-btn');
        const submitPrayerBtn = document.getElementById('submit-prayer-btn');
        const castBlocksBtn = document.getElementById('cast-blocks-btn');
        const drawFortuneBtn = document.getElementById('draw-fortune-btn');
        const resetBtn = document.getElementById('reset-btn');

        // 靈籤資料
        const fortunes = [
            { title: "大吉", text: "雲開月出見分明，不須進退問前程，婚姻皆由天註定，和合清吉萬事成。" },
            { title: "中吉", text: "舊恨重重未改為，家中禍患不臨身，須當謹防宜作福，龍蛇交會得和合。" },
            { title: "小吉", text: "一紙官書火急催，扁舟速下浪如雷，雖然目下多驚險，保汝平安去復回。" },
            { title: "平", text: "勞心費力欲成功，待得花開一陣風，多謝東風輕借力，望東別有一枝紅。" },
            { title: "凶", text: "風雲致雨落洋洋，天災時氣必有傷，禳禱厭禳神保佑，闔家大小定安康。" }
        ];

        let hasOfferedFruits = false;
        let hasOfferedFlowers = false;

        function updateMessage(msg, duration = 2000) {
            messageBoard.textContent = msg;
        }

        async function callGeminiAPI(prayer, fortuneTitle, fortuneText) {
            const apiKey = ""; // Leave this as-is
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "您是一位慈悲為懷、充滿智慧的觀音菩薩。請用溫和、鼓勵且富有禪意的語氣，為信眾解說籤詩的深層含義。您的解析應結合信眾的祈願內容，給予他們方向和心靈的慰藉，而非直接給予絕對的是非答案。請以『善信，你所求之事...』開頭。";
            const userQuery = `信眾的祈願是：「${prayer}」。抽到的籤詩是「${fortuneTitle} - ${fortuneText}」。請基於此祈願，為信眾開示這支籤的意義。`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    return "觀音菩薩今日稍作歇息，請靜心體會籤詩原意。";
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "與觀音菩薩的連結似乎有些不穩定，請稍後再試。";
            }
        }
        
        // 1. 上香
        incenseBtn.addEventListener('click', () => {
            incense.classList.add('visible');
            updateMessage('您已上香，請獻上供品。');
            incenseBtn.disabled = true;
            offeringBtn.disabled = false;
        });

        // 2. 獻供
        offeringBtn.addEventListener('click', () => {
            if (!hasOfferedFruits) {
                fruits.classList.add('visible');
                hasOfferedFruits = true;
                updateMessage('獻上水果。請繼續獻上鮮花。');
            } else if (!hasOfferedFlowers) {
                flowers.classList.add('visible');
                hasOfferedFlowers = true;
                updateMessage('供品已獻齊，請誠心祈福。');
                offeringBtn.disabled = true;
                prayBtn.disabled = false;
            }
        });

        // 3. 祈福
        prayBtn.addEventListener('click', () => {
            prayerSection.classList.remove('hidden');
            prayerSection.classList.add('flex');
            updateMessage('請在下方輸入您的祈願。');
            prayBtn.disabled = true;
        });

        submitPrayerBtn.addEventListener('click', () => {
            prayerSection.classList.add('hidden');
            prayerSection.classList.remove('flex');
            if (prayerText.value.trim() === '') {
                 updateMessage('您的祈願已默念心中，請擲筊問事。');
            } else {
                 updateMessage('神明已聽見您的祈願，請擲筊問事。');
            }
            castBlocksBtn.disabled = false;
        });

        // 4. 擲筊
        castBlocksBtn.addEventListener('click', () => {
            fortuneSlip.classList.add('hidden');
            geminiSection.classList.add('hidden');
            geminiResult.style.display = 'none';
            const result = Math.floor(Math.random() * 3);
            drawFortuneBtn.disabled = true; 
            
            setTimeout(() => {
                if (result === 0) { // 聖筊
                    jiaobeiResult.textContent = '🌕🌑 聖筊 - 神明同意了您的請求。';
                    jiaobeiResult.style.color = '#4ade80';
                    updateMessage('獲得聖筊，您可以求取靈籤。');
                    drawFortuneBtn.disabled = false;
                } else if (result === 1) { // 笑筊
                    jiaobeiResult.textContent = '🌕🌕 笑筊 - 神明在笑。';
                    jiaobeiResult.style.color = '#facc15';
                    updateMessage('問題不明確或時機未到，請重新整理心情再問一次。');
                } else { // 陰筊
                    jiaobeiResult.textContent = '🌑🌑 陰筊 - 神明不同意。';
                    jiaobeiResult.style.color = '#f87171';
                    updateMessage('此事不可行，請勿強求。');
                }
            }, 500);
            
            jiaobeiResult.textContent = '擲筊中...';
        });

        // 5. 求籤
        drawFortuneBtn.addEventListener('click', () => {
            const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            fortuneTitle.textContent = `【${randomFortune.title}】`;
            fortuneText.textContent = randomFortune.text;
            
            fortuneSlip.classList.remove('hidden');
            geminiSection.classList.remove('hidden');
            geminiBtn.style.display = 'block';
            geminiResult.style.display = 'none';
            geminiResult.textContent = '';
            
            updateMessage('您獲得了靈籤，可請觀音開示。');
            drawFortuneBtn.disabled = true;
        });

        // ✨ Gemini API 解籤
        geminiBtn.addEventListener('click', async () => {
            geminiBtn.style.display = 'none';
            geminiLoading.classList.remove('hidden');
            
            const userPrayer = prayerText.value.trim() === '' ? '信眾未填寫祈願，只求心中指引' : prayerText.value;
            const fTitle = fortuneTitle.textContent;
            const fText = fortuneText.textContent;
            
            const interpretation = await callGeminiAPI(userPrayer, fTitle, fText);
            
            geminiResult.textContent = interpretation;
            geminiLoading.classList.add('hidden');
            geminiResult.style.display = 'block';
        });
        
        // 重設
        resetBtn.addEventListener('click', () => {
            incense.classList.remove('visible');
            fruits.classList.remove('visible');
            flowers.classList.remove('visible');
            prayerSection.classList.add('hidden');
            prayerSection.classList.remove('flex');
            fortuneSlip.classList.add('hidden');
            geminiSection.classList.add('hidden');
            
            incenseBtn.disabled = false;
            offeringBtn.disabled = true;
            prayBtn.disabled = true;
            castBlocksBtn.disabled = true;
            drawFortuneBtn.disabled = true;
            
            prayerText.value = '';
            jiaobeiResult.textContent = '';
            hasOfferedFruits = false;
            hasOfferedFlowers = false;

            updateMessage('請點擊「上香」開始您的參拜。');
        });

    </script>
</body>
</html>

